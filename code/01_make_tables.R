library(here)
library(dplyr)
here::i_am("code/01_make_tables.R")


# Load the cleaned data
covid <- readRDS(here::here("output/data_clean.rds"))

# Frequency of respiratory diseases (PNEUMONIA, COPD, and ASTHMA)----------------------------------------------------------------
table_resp <- covid %>%
  select(CASE_STATUS, PNEUMONIA, COPD, ASTHMA) %>%
  group_by(CASE_STATUS) %>%
  summarise(
    PNEUMONIA = sum(PNEUMONIA == "Yes", na.rm = TRUE),
    COPD = sum(COPD == "Yes", na.rm = TRUE),
    ASTHMA = sum(ASTHMA == "Yes", na.rm = TRUE),
  ) %>%
  as.data.frame() %>%
  rename("COVID-19 Status"=CASE_STATUS)


## Save the table to output/table_resp.rds
saveRDS(table_resp, file = here::here("output/table_resp.rds"))


# Frequency of non-respiratory diseases (DIABETES, CARDIOVASCULAR, OBESITY, RENAL_CHRONIC, HYPERTENSION)-------------------------
table_nonresp <- covid %>%
  select(CASE_STATUS, DIABETES, CARDIOVASCULAR, OBESITY, RENAL_CHRONIC, HIPERTENSION) %>%
  group_by(CASE_STATUS) %>%
  summarise(
    DIABETES = sum(DIABETES == "Yes", na.rm = TRUE),
    CARDIOVASCULAR = sum(CARDIOVASCULAR == "Yes", na.rm = TRUE),
    OBESITY = sum(OBESITY == "Yes", na.rm = TRUE),
    RENAL_CHRONIC = sum(RENAL_CHRONIC == "Yes", na.rm = TRUE),
    HIPERTENSION = sum(HIPERTENSION == "Yes", na.rm = TRUE)
  ) %>%
  as.data.frame() %>%
  rename("COVID-19 Status"=CASE_STATUS,
         "CHRONIC RENAL"=RENAL_CHRONIC)

## Save the table to output/table_nonresp.rds
saveRDS(table_nonresp, file = here::here("output/table_nonresp.rds"))



# Frequency of severity variables (ICU, INTUBED, DIED)----------------------------------------------------------------------------
table_severity <- covid %>%
  select(CASE_STATUS, ICU, INTUBED, DIED) %>%
  group_by(CASE_STATUS) %>%
  summarise(
    ICU = sum(ICU == "Yes", na.rm = TRUE),
    INTUBED = sum(INTUBED == "Yes", na.rm = TRUE),
    DIED = sum(DIED == 1, na.rm = TRUE),
  ) %>%
  as.data.frame() %>%
  rename("COVID-19 Status"=CASE_STATUS)

## Save the table to output/table_severity.rds
saveRDS(table_severity, file = here::here("output/table_severity.rds"))

# Overall summary of demographic variables (CASE_STATUS, SEX, and AGE)---------------------------
table_demo <- covid %>%
  summarise(
    `Total Cases` = n(),
    `Not Severe Cases` = sum(CASE_STATUS == "1", na.rm = TRUE),
    `Severe Cases` = sum(CASE_STATUS == "0", na.rm = TRUE),
    Male = sum(SEX == "Male", na.rm = TRUE),
    Female = sum(SEX == "Female", na.rm = TRUE),
    `Age (mean)` = mean(AGE, na.rm = TRUE),
    `Age (median)` = median(AGE, na.rm = TRUE),
    `Age (min)` = min(AGE, na.rm = TRUE),
    `Age (max)` = max(AGE, na.rm = TRUE)
  ) %>%
  as.data.frame()

# Save the table to output/table_demo.rds
saveRDS(table_demo, file = here::here("output/table_demo.rds"))